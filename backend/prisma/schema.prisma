generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Event {
  id               String            @id @default(uuid())
  title            String            @db.VarChar(500)
  description      String?
  adminPeriod      AdminPeriod       @map("admin_period")
  concernLevel     StrengthRating?   @map("concern_level")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  startDate        DateTime          @map("start_date") @db.Date
  endDate          DateTime?         @map("end_date") @db.Date
  counterNarrative CounterNarrative?
  tags             EventTag[]
  sources          Source[]

  @@index([startDate])
  @@index([endDate])
  @@index([adminPeriod])
  @@map("events")
}

model Tag {
  id          String     @id @default(uuid())
  name        String     @unique @db.VarChar(100)
  description String?    @db.VarChar(500)
  color       String     @default("#6B7280") @db.VarChar(7)
  isDefault   Boolean    @default(false) @map("is_default")
  createdAt   DateTime   @default(now()) @map("created_at")
  events      EventTag[]

  @@map("tags")
}

model EventTag {
  eventId   String  @map("event_id")
  tagId     String  @map("tag_id")
  isPrimary Boolean @default(false) @map("is_primary")
  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([eventId, tagId])
  @@map("event_tags")
}

model Source {
  id                 String            @id @default(uuid())
  eventId            String?           @map("event_id")
  counterNarrativeId String?           @map("counter_narrative_id")
  publicationId      String?           @map("publication_id")
  url                String            @db.VarChar(2048)
  articleTitle       String?           @map("article_title") @db.VarChar(500)
  biasRating         Int               @map("bias_rating") @db.SmallInt
  dateAccessed       DateTime          @default(now()) @map("date_accessed") @db.Date
  isArchived         Boolean           @default(false) @map("is_archived")
  createdAt          DateTime          @default(now()) @map("created_at")
  event              Event?            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  counterNarrative   CounterNarrative? @relation(fields: [counterNarrativeId], references: [id], onDelete: Cascade)
  publication        Publication?      @relation(fields: [publicationId], references: [id])
  claims             Claim[]

  @@index([eventId])
  @@index([counterNarrativeId])
  @@map("sources")
}

model Publication {
  id          String   @id @default(uuid())
  name        String   @unique @db.VarChar(200)
  domain      String   @unique @db.VarChar(253)
  defaultBias Int      @map("default_bias") @db.SmallInt
  credibility String?  @db.VarChar(20)
  sources     Source[]

  @@map("publications")
}

model CounterNarrative {
  id            String   @id @default(uuid())
  eventId       String   @unique @map("event_id")
  narrative     String   @map("narrative_text")
  adminPosition String?  @map("admin_strength")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sources       Source[]

  @@map("counter_narratives")
}

enum AdminPeriod {
  TRUMP_1
  TRUMP_2
  OTHER
}

enum StrengthRating {
  weak
  moderate
  strong
}

enum ClaimCategory {
  FACTUAL_ASSERTION
  OPINION_ANALYSIS
  SPECULATION
}

model Domain {
  id               String   @id @default(uuid())
  normalizedDomain String   @unique @map("normalized_domain") @db.VarChar(253)
  totalSources     Int      @default(0) @map("total_sources")
  avgBiasRating    Decimal? @map("avg_bias_rating") @db.Decimal(4, 2)
  usageFrequency   Int      @default(0) @map("usage_frequency")
  firstSeen        DateTime @default(now()) @map("first_seen")
  lastUsed         DateTime @default(now()) @map("last_used") @updatedAt

  @@index([normalizedDomain])
  @@index([lastUsed(sort: Desc)])
  @@map("domains")
}

model Claim {
  id              String        @id @default(uuid())
  sourceId        String        @map("source_id")
  claimText       String        @map("claim_text") @db.Text
  category        ClaimCategory
  confidenceScore Decimal       @map("confidence_score") @db.Decimal(3, 2)
  extractedAt     DateTime      @default(now()) @map("extracted_at")
  source          Source        @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId])
  @@index([category])
  @@index([confidenceScore(sort: Desc)])
  @@map("claims")
}
